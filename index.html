<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TYFYS Objection Coach</title>

<style>
:root{
  /* Dark UI palette inspired by your mockup */
  --bg:#0b1020;          /* deep navy */
  --panel:#121934;       /* card surface */
  --panel-2:#0f1730;
  --text:#e8ecff;        /* near-white */
  --muted:#a6b2d6;       /* secondary text */
  --border:#24305b;
  --accent:#6d5dfc;      /* purple */
  --accent-2:#3aa0ff;    /* blue */
  --accent-3:#9a8bff;    /* soft violet */
  --chip:#1b2446;
  --chip-border:#2a3770;
  --shadow:0 14px 30px rgba(0,0,0,.35);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:
    radial-gradient(1200px 600px at 70% -10%, #1a2250, transparent 55%),
    radial-gradient(900px 500px at -10% 10%, #111a3b, transparent 50%),
    var(--bg);
  color:var(--text);
  font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
}

.container{max-width:1120px;margin:28px auto;padding:0 16px}
.header{display:flex;align-items:center;gap:12px;margin-bottom:10px}
.logo{width:38px;height:38px;border-radius:10px;background:
  linear-gradient(135deg,var(--accent),var(--accent-2));
  display:grid;place-items:center;color:#fff;font-weight:800;border:2px solid #7ea8ff;box-shadow:0 6px 16px rgba(61,137,255,.35)}
h1{font-size:28px;letter-spacing:.3px;margin:0}
.sub{color:var(--muted);font-size:13px;margin:6px 0 18px}

.chat{
  background:linear-gradient(180deg,var(--panel),var(--panel-2));
  border:1px solid var(--border);
  border-radius:18px; padding:18px;
  box-shadow:var(--shadow);
}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.input, .tags, .pw, .select{
  width:100%; padding:12px; border-radius:12px; color:var(--text);
  background:#0f1730; border:1px solid var(--border)
}
.input{min-height:104px; resize:vertical}
.tags{margin-top:8px}
.select, .pw{appearance:none}

.actions{display:flex;gap:12px;margin-top:12px;align-items:center;flex-wrap:wrap}
.btn{
  border:1px solid #7ea8ff;
  background:linear-gradient(90deg,var(--accent),var(--accent-2));
  color:#fff;font-weight:700;padding:12px 16px;border-radius:14px;cursor:pointer;
  box-shadow:0 10px 22px rgba(61,137,255,.35);
}
.btn:disabled{opacity:.6;cursor:not-allowed}
.status{background:#0f1730;border:1px solid var(--border);border-radius:12px;padding:10px 12px;font-size:13px;color:var(--muted)}
progress{width:100%}

.card{background:#0f1730;border:1px solid var(--border);border-radius:16px;padding:14px;margin-top:12px}
.card h3{margin:0 0 8px 0;font-size:16px;color:#cdd7ff}

/* Reply bubble */
.bubble{border:1px solid var(--border);border-radius:16px;padding:14px;background:#10193a}
.bubble.ai{border-color:#5162ff;box-shadow:0 10px 24px rgba(109,93,252,.22)}
.reply p{margin:0 0 8px 0;line-height:1.45}
.reply strong{color:var(--accent-3)}
.reply ul{margin:6px 0 0 18px}

/* Top matches */
ol{margin:10px 0 0 18px}
li small{color:var(--muted)}
.chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--chip-border);font-size:12px;color:#cfe1ff}

.hint{color:var(--muted);font-size:12px;margin-top:8px}
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">T</div>
      <div>
        <h1>TYFYS Objection Coach</h1>
        <div class="sub">Urgent, kind objection handling. Runs locally in your browser.</div>
      </div>
    </div>

    <div class="chat">
      <div class="row">
        <input id="pw" class="pw" type="password" placeholder="Optional passphrase (leave blank to skip)" />
        <select id="model" class="select">
          <option value="Llama-3.2-3B-Instruct-q4f32_1-MLC" selected>Llama-3.2-3B (default)</option>
          <option value="Gemma-2-2B-it-q4f32_1-MLC">Gemma-2 2B</option>
        </select>
      </div>

      <textarea id="snippet" class="input" placeholder="Transcript snippet… e.g., I need to speak with my wife."></textarea>
      <input id="tags" class="tags" placeholder="Optional tags: vso, pricing, stall" />

      <div class="actions">
        <button id="go" class="btn">Suggest reply</button>
        <div class="status">
          <b>Status:</b> <span id="stat">Initializing…</span>
          <div id="progWrap" style="display:none;margin-top:6px">
            <progress id="prog" value="0" max="1"></progress>
            <div id="progText" class="hint"></div>
          </div>
        </div>
      </div>

      <div id="out" class="card"></div>
      <div id="matches" class="card"></div>
      <div class="hint">Tip: add <span class="chip">vso</span> or <span class="chip">pricing</span> in “tags” to steer matches.</div>
    </div>
  </div>

<script type="module">
  // ---------- UI refs ----------
  const stat = document.getElementById('stat');
  const prog = document.getElementById('prog');
  const progWrap = document.getElementById('progWrap');
  const progText = document.getElementById('progText');
  const out = document.getElementById('out');
  const matchesDiv = document.getElementById('matches');
  const go = document.getElementById('go');
  const modelSel = document.getElementById('model');
  go.disabled = true;

  // ---------- Load playbook ----------
  let KB=[];
  try{
    const r=await fetch('objections.json',{cache:'no-store'});
    if(!r.ok) throw new Error('objections.json missing');
    KB = await r.json();
  }catch(e){
    stat.textContent='Error: '+e.message;
  }

  function score(snippet,tagsCsv,item){
    const s=(snippet||'').toLowerCase(); let sc=0;
    const text=[item.objection,item.rebuttal,item.proof].filter(Boolean).join(' ').toLowerCase();
    ['money','cost','fee','vso','dav','lawyer','risk','timeline','denied','rating','scam','family','wife','husband','think','wait','schedule','call','today','tomorrow'].forEach(k=>{
      if(s.includes(k)&&text.includes(k)) sc+=2;
    });
    const obj=(item.objection||'').toLowerCase();
    if(obj && s.includes(obj.slice(0,18))) sc+=2;
    const want=new Set((tagsCsv||'').split(',').map(x=>x.trim().toLowerCase()).filter(Boolean));
    const have=new Set((item.tags||[]).map(x=>String(x).toLowerCase()));
    for(const t of want) if(have.has(t)) sc+=1;
    return sc;
  }
  function topK(snippet,tagsCsv,k=3){
    const arr=KB.map(x=>({item:x,s:score(snippet,tagsCsv,x)})).sort((a,b)=>b.s-a.s).slice(0,k).map(x=>x.item);
    return arr.length?arr:KB.slice(0,k);
  }

  // ---------- WebLLM ----------
  import * as webllm from "https://esm.run/@mlc-ai/web-llm";
  let engine=null;

  async function initEngine(modelName){
    stat.textContent=`Loading ${modelName}…`;
    progWrap.style.display='block'; prog.value=0; progText.textContent='';
    try{
      engine = await webllm.CreateMLCEngine(modelName,{
        gpuMemoryUtilization:0.7,
        initProgressCallback:(p)=>{
          if(p.text) progText.textContent=p.text;
          if(typeof p.progress==='number') prog.value=p.progress;
          if(p.error){ stat.textContent='Error: '+p.error; }
          if(p.progress===1){
            stat.textContent='Model ready.'; progWrap.style.display='none'; go.disabled=false;
          }
        }
      });
    }catch(e){
      stat.textContent='Engine init failed: '+e.message;
    }
  }
  await initEngine(modelSel.value);
  modelSel.onchange = async ()=>{ go.disabled=true; await initEngine(modelSel.value); };

  // ---------- Prompt: assumptive, urgent, kind ----------
  const SYS = `
You are a VA-disability objection coach for Thank You For Your Service (TYFYS).
Tone: urgent but kind, never pushy or arrogant. Use **assumptive next steps** that reduce friction NOW.
If a spouse/family/rep is mentioned, **assume alignment is helpful** and propose a same-day 3-way call or immediate scheduling.
Return HTML only in this structure:

<div class="bubble ai reply">
  <p><strong>Acknowledge:</strong> <span>one empathetic sentence.</span></p>
  <p><strong>Clarify:</strong> <span>one question that advances the decision.</span></p>
  <p><strong>Offer:</strong></p>
  <ul>
    <li>Option A: <span>assumptive immediate action (e.g., “Perfect—let’s loop your wife in now. I can add her to a 3-way call while we’re here.”).</span></li>
    <li>Option B: <span>near-term fallback with urgency (e.g., “If now isn’t ideal, I’ll book a quick three-way for this afternoon or tomorrow morning—what time works?”).</span></li>
  </ul>
</div>

Keep ≤120 words. No legal advice. Speakable phrasing.
`;

  async function generate(snippet,matches){
    const ctx = matches.map(m=>`Objection: ${m.objection}\nBestReply: ${m.rebuttal}\nProof: ${m.proof||""}`).join("\n\n");
    const res = await engine.chat.completions.create({
      messages:[
        {role:"system",content:SYS},
        {role:"user",content:`Context:\n${ctx}\n\nTranscript:\n${snippet}\n\nCoach reply:`}
      ],
      temperature:0.45, max_tokens:220
    });
    return res.choices[0].message.content;
  }

  // ---------- Click ----------
  go.onclick = async ()=>{
    if(!engine){ out.innerHTML='<div class="bubble">Model still loading.</div>'; return; }
    const pw=document.getElementById('pw').value.trim();
    if(pw && pw!=='TYFYS2025'){ out.innerHTML='<div class="bubble">Access denied.</div>'; return; }
    const snippet=document.getElementById('snippet').value.trim();
    if(!snippet){ out.innerHTML='<div class="bubble">Enter a snippet.</div>'; return; }
    const tags=document.getElementById('tags').value.trim();

    const picks=topK(snippet,tags,3);
    matchesDiv.innerHTML = `<h3>Top matches</h3><ol>`+
      picks.map(m=>`<li><b>${m.objection||'Untitled'}</b><br><small>${m.rebuttal||''}</small></li>`).join('')+
      `</ol>`;

    out.innerHTML='<div class="bubble">Thinking…</div>';
    try{
      const html = await generate(snippet,picks);
      out.innerHTML = html;
    }catch(e){
      out.innerHTML='<div class="bubble">AI error: '+e.message+'</div>';
    }
  };
</script>
</body>
</html>
