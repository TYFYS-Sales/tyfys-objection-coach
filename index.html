<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TYFYS Objection Coach</title>
<style>
body{font-family:system-ui,sans-serif;max-width:900px;margin:24px auto;padding:0 12px}
textarea,input,button,select{width:100%;padding:12px;margin:8px 0;border:1px solid #ddd;border-radius:10px}
.k{padding:10px;border:1px solid #eee;border-radius:12px;margin:8px 0}
small{color:#666}
button{cursor:pointer}
#status{font-size:12px;color:#333}
progress{width:100%}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
</style>
</head>
<body>
<h1>TYFYS Objection Coach</h1>
<p><small>Paste a transcript snippet. Top matches come from your playbook. Reply is drafted by a small in-browser LLM.</small></p>

<div class="row">
  <input id="pw" type="password" placeholder="Optional passphrase (leave blank to skip)" />
  <select id="model">
    <option value="Llama-3.2-3B-Instruct-q4f32_1-MLC" selected>Llama-3.2-3B-Instruct (fast)</option>
    <option value="Phi-3-mini-4k-instruct-q4f32_1-MLC">Phi-3-Mini-Instruct</option>
    <option value="Gemma-2-2B-it-q4f32_1-MLC">Gemma-2-2B-IT</option>
  </select>
</div>

<textarea id="snippet" rows="4" placeholder="Transcript snippet…"></textarea>
<input id="tags" placeholder="Optional tags: vso, pricing, stall" />
<button id="go">Suggest reply</button>

<div id="status" class="k">
  <b>Status:</b> <span id="stat">Initializing…</span>
  <div id="progWrap" style="display:none">
    <progress id="prog" value="0" max="1"></progress>
    <div><small id="progText"></small></div>
  </div>
</div>

<div id="out" class="k"></div>
<div id="matches" class="k"></div>

<script type="module">
  // --- UI refs ---
  const stat = document.getElementById('stat');
  const prog = document.getElementById('prog');
  const progWrap = document.getElementById('progWrap');
  const progText = document.getElementById('progText');
  const out = document.getElementById('out');
  const matchesDiv = document.getElementById('matches');
  const go = document.getElementById('go');
  const modelSel = document.getElementById('model');
  go.disabled = true;

  // --- Load playbook ---
  let KB=[];
  try{
    const r=await fetch('objections.json',{cache:'no-store'});
    if(!r.ok) throw new Error('objections.json missing');
    KB = await r.json();
  }catch(e){ stat.textContent='Error: '+e.message; }

  function score(snippet,tagsCsv,item){
    const s=(snippet||'').toLowerCase(); let sc=0;
    const text=[item.objection,item.rebuttal,item.proof].filter(Boolean).join(' ').toLowerCase();
    ['money','cost','fee','vso','dav','lawyer','risk','timeline','denied','rating','scam'].forEach(k=>{
      if(s.includes(k)&&text.includes(k)) sc+=2;
    });
    const obj=(item.objection||'').toLowerCase();
    if(obj && s.includes(obj.slice(0,18))) sc+=2;
    const want=new Set((tagsCsv||'').split(',').map(x=>x.trim().toLowerCase()).filter(Boolean));
    const have=new Set((item.tags||[]).map(x=>String(x).toLowerCase()));
    for(const t of want) if(have.has(t)) sc+=1;
    return sc;
  }
  function topK(snippet,tagsCsv,k=3){
    const arr=KB.map(x=>({item:x,s:score(snippet,tagsCsv,x)})).sort((a,b)=>b.s-a.s).slice(0,k).map(x=>x.item);
    return arr.length?arr:KB.slice(0,k);
  }

  // --- WebLLM import (ESM CDN) ---
  import * as webllm from "https://esm.run/@mlc-ai/web-llm";
  let engine=null;

  async function initEngine(modelName){
    stat.textContent=`Loading ${modelName}…`;
    progWrap.style.display='block'; prog.value=0; progText.textContent='';
    try{
      engine = await webllm.CreateMLCEngine(modelName,{
        gpuMemoryUtilization:0.7,
        initProgressCallback:(p)=>{
          if(p.text) progText.textContent=p.text;
          if(typeof p.progress==='number') prog.value=p.progress;
          if(p.error){ stat.textContent='Error: '+p.error; }
          if(p.progress===1){
            stat.textContent='Model ready.'; progWrap.style.display='none'; go.disabled=false;
          }
        }
      });
    }catch(e){
      stat.textContent='Engine init failed: '+e.message;
    }
  }

  // Start with the smaller model
  modelSel.value = "Phi-3-mini-4k-instruct-q4f32_1-MLC";
  await initEngine(modelSel.value);
  modelSel.onchange = async ()=>{ go.disabled=true; await initEngine(modelSel.value); };

  const SYS="You are a TYFYS VA-claims objection coach. Reply in 3 parts: 1) Acknowledge 2) One clarifying question 3) Offer two concise options. No legal advice. ≤80 words. Calm. Factual.";

  async function generate(snippet,matches){
    const ctx = matches.map(m=>`Objection: ${m.objection}\nBestReply: ${m.rebuttal}\nProof: ${m.proof||""}`).join("\n\n");
    const res = await engine.chat.completions.create({
      messages:[{role:"system",content:SYS},{role:"user",content:`Context:\n${ctx}\n\nTranscript:\n${snippet}\n\nCoach reply:`}],
      temperature:0.2, max_tokens:140
    });
    return res.choices[0].message.content;
  }

  document.getElementById('go').onclick = async ()=>{
    if(!engine){ out.textContent='Model still loading.'; return; }
    const pw=document.getElementById('pw').value.trim();
    if(pw && pw!=='TYFYS2025'){ out.textContent='Access denied.'; return; }
    const snippet=document.getElementById('snippet').value.trim();
    if(!snippet){ out.textContent='Enter a snippet.'; return; }
    const tags=document.getElementById('tags').value.trim();

    const picks=topK(snippet,tags,3);
    matchesDiv.innerHTML = `<b>Top matches</b><ol>`+picks.map(m=>`<li><b>${m.objection||'Untitled'}</b><br><small>${m.rebuttal||''}</small></li>`).join('')+`</ol>`;
    out.textContent='Thinking…';
    try{ out.textContent = await generate(snippet,picks); }
    catch(e){ out.textContent='AI error: '+e.message; }
  };
</script>
</body>
</html>
